<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Accurate GPS Location with Address</title>
  </head>
  <body>
    <button onclick="startWatching()">
      Start GPS Tracking (High Accuracy)
    </button>
    <button onclick="stopWatching()">Stop GPS Tracking</button>
    <div id="output"></div>

    <script>
      let watchId = null;

      function startWatching() {
        if (navigator.geolocation) {
          watchId = navigator.geolocation.watchPosition(
            showPosition,
            showError,
            {
              enableHighAccuracy: true,
              timeout: 20000,
              maximumAge: 0,
            }
          );
          document.getElementById("output").innerHTML =
            "Waiting for GPS data...";
        } else {
          document.getElementById("output").innerText =
            "Geolocation is not supported.";
        }
      }

      function stopWatching() {
        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
          document.getElementById("output").innerHTML = "GPS tracking stopped.";
        }
      }

      function showPosition(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const accuracy = position.coords.accuracy;

        document.getElementById("output").innerHTML = `Latitude: ${lat}<br>
        Longitude: ${lon}<br>
        Accuracy: ${accuracy.toFixed(2)} meters<br>`;

        if (accuracy <= 20) {
          getAddress(lat, lon);
          stopWatching();
        } else {
          document.getElementById("output").innerHTML +=
            "Waiting for better accuracy (<= 20 meters)...";
        }
      }

      async function getAddress(lat, lon) {
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`
          );
          const data = await response.json();

          if (data && data.display_name) {
            document.getElementById(
              "output"
            ).innerHTML += `<br>Address: ${data.display_name}`;
          } else {
            document.getElementById("output").innerHTML +=
              "<br>Address not found.";
          }
        } catch (error) {
          document.getElementById("output").innerHTML +=
            "<br>Failed to fetch address.";
        }
      }

      function showError(error) {
        let message = "";
        switch (error.code) {
          case error.PERMISSION_DENIED:
            message = "User denied the request for Geolocation.";
            break;
          case error.POSITION_UNAVAILABLE:
            message = "Location information is unavailable.";
            break;
          case error.TIMEOUT:
            message = "The request to get user location timed out.";
            break;
          case error.UNKNOWN_ERROR:
            message = "An unknown error occurred.";
            break;
        }
        document.getElementById("output").innerText = message;
      }
    </script>
  </body>
</html>
